name: Charlotte Bridge

on:
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python (optional)
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install deps (optional)
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || true

      - name: Prepare output folders
        run: |
          mkdir -p output logs

      - name: Run job / simulation
        run: |
          echo "Replace this with your real command(s)" | tee -a logs/run.log
          # Example:
          # bash scripts/run.sh 2>&1 | tee -a logs/run.log

      - name: Collect diagnostics on failure
        if: failure()
        run: |
          dmesg | tail -n 200 > logs/dmesg_tail.txt || true
          journalctl -n 200 --no-pager > logs/journal_tail.txt || true

      # ✅ Create placeholder so upload never fails
      - name: Create artifact placeholders
        if: always()
        run: |
          mkdir -p output logs
          echo "ok" > logs/keep.json

      # ✅ Upload artifacts (fixed version)
      - name: Upload sim outputs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sim-output-${{ github.run_id }}
          path: |
            output/**
            logs/**
          include-hidden-files: true
          if-no-files-found: ignore
          retention-days: 7

      - name: Post to Slack (optional)
        if: always() && env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -sS -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"Charlotte Bridge run ${{ github.run_id }} finished with status: ${{ job.status }}\"}" \
            "$SLACK_WEBHOOK_URL" || true



      