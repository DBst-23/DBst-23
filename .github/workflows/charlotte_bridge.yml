name: Charlotte Bridge

on:
  push:
    paths:
      - ".github/workflows/charlotte_bridge.yml"
      - "scripts/**"
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: charlotte-bridge-${{ github.ref }}
  cancel-in-progress: true

jobs:
  run:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Python (optional)
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps (optional)
        run: |
          pip install -r requirements.txt || true

      - name: Prepare output folders
        if: always()
        run: |
          set -euxo pipefail
          mkdir -p output logs
          date -u +"%Y-%m-%dT%H:%M:%SZ" | tee logs/start_time.txt
          echo "run_id=${GITHUB_RUN_ID}" | tee output/summary.txt
          printf '{"heartbeat":"ok","run_id":"%s","sha":"%s"}\n' "${GITHUB_RUN_ID}" "${GITHUB_SHA}" > logs/keep.json

      - name: Run job / simulation
        run: |
          echo "Replace this with your real command(s)" | tee -a logs/run.log
          # Example:
          # bash scripts/run.sh 2>&1 | tee -a logs/run.log

      - name: Collect diagnostics on failure
        if: failure()
        run: |
          dmesg | tail -n 200 > logs/dmesg_tail.txt || true
          journalctl -n 200 --no-pager > logs/journal_tail.txt || true

      - name: Upload sim outputs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sim-output-${{ github.run_id }}
          path: |
            output/**
            logs/**
          include-hidden-files: true
          if-no-files-found: upload
          retention-days: 7

      - name: Post to Slack (optional)
        if: always() && env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -sS -X POST -H 'Content-type: application/json' \
          --data "{\"text\":\"Charlotte Bridge run ${GITHUB_RUN_ID} finished with status: ${{ job.status }}\"}" \
          "$SLACK_WEBHOOK_URL" || true
       


      